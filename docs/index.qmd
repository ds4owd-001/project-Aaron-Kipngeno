---
title: "willingness to invest in sanitation facilities"
date: today
author: "Aaron Kipngeno"
format:
  html:
    embed-resources: true
    toc: true
execute:
  warning: false
editor_options: 
  chunk_output_type: console
---

```{r echo= TRUE}
#| label: load-packages
library(readr)
library(tidyverse)
```

# Project description

Data analysis to determine factors that influence households willingeness to invest in sanitation facilities in Bomet Sub-county.

objectives of the study

#1. To assess the proportion of willingness to invest in sanitation facilities by households in Bomet Sub-county.

#2. To determine the demographic and socio-cultural factors that influences the willingness to invest in sanitation facilities by households in Bomet Sub-county.

#3. To determine the economic and financial factors that influences the willingness to invest in sanitation facilities by householdsin Bomet Sub-county.

## Data Import

```{r}
sanitation <- read_csv(here::here("data/raw/Sanitation_investiment.csv"))
```

### Explore data

```{r}
head(sanitation)
tail(sanitation)
glimpse(sanitation)
str(sanitation)
nrow(sanitation)
ncol(sanitation)
```

## data cleaning

```{r}
#data transformations - rename/relocate/muatate/removing 
sanitation_clean <- sanitation |>
mutate(id = row_number()) |>
  relocate(id) |> 
  janitor::clean_names()

sanitation_clean <- sanitation_clean |>
       rename(community_health_officers =  "source_of_information_community_health_volunteers",
      media ="source_of_information_media",
    ngo_workers = "source_of_information_ngo_workers",
  local_markertes = "source_of_information_local_marketers",
  others =  "source_of_information_others",
  quality_of_toilet = "quality_of_toilet_25",
 latrine_charcteristics = "quality_of_toilet_30",
motivating_factors = "if_yes_motivating_factors",)

sanitation_clean <- sanitation_clean |> 
  rename(public_health_officers = "source_of_information_public_health_officers")

#removing column
sanitation_clean$source_of_information = NULL
sanitation_clean$motivating_factors = NULL
sanitation_clean$culture= NULL
sanitation_clean$impacts_of_open_defecation = NULL

```

### converting categorical variables to factors

```{r}
sanitation_clean <- sanitation_clean |>
  mutate(age_bracket = factor(age_bracket))

sanitation_clean |>
   mutate(gender = factor(gender))

education_levels <- c("no education", "primary", "secondary", "college", "university")
sanitation_clean <- sanitation_clean |>
  mutate(education = factor(education,levels = education_levels))

income_levels <- c("0-1000", "1001-5000", "5001-10000", "10001-20000","20001-50000", "50001")
sanitation_clean <- sanitation_clean |>
  mutate(income = factor(income, levels = income_levels))

religion_levels <- c("christian",  "muslim", "Other")
sanitation_clean <- sanitation_clean |>
  mutate(religion = factor(religion, levels = religion_levels))

sanitation_clean <- sanitation_clean |>
  mutate(sanitation_organizations = factor(sanitation_organizations),
         employement_status = factor(employement_status),
         willingness_to_invest = factor(willingness_to_invest),
         level_of_willingness = factor(level_of_willingness),
         knowledge_on_financial_institutions = factor(knowledge_on_financial_institutions),
         member_to_savings_and_lendings_groups = factor(member_to_savings_and_lendings_groups),
         loan = factor(loan),
         sanitation_loan = factor(sanitation_loan),
         if_no = factor(if_no),
         know_sanitation = factor(know_sanitation),
         presence_of_latrine = factor(presence_of_latrine),
         type_latrine_own = factor(type_latrine_own),
         benefit_of_use_latrine = factor(benefit_of_use_latrine),
         sanitation_organizations = factor(sanitation_organizations),
         know_sanitation = factor(know_sanitation),
         cost_of_latrine = (cost_of_latrine),
         sanitation_laws = factor(sanitation_laws))
attach(sanitation_clean)

#checking var(class and level)
class(sanitation_clean$benefit_of_use_latrine) 
levels(sanitation_clean$benefit_of_use_latrine)

```

### data cleaning for multiple choice questions

```{r}
#1 Where do you mainly get information on sanitation?

sanitation_information <- sanitation_clean |> 
  select( public_health_officers:others) |> 
  pivot_longer(cols = public_health_officers:others,
               names_to = "information",
               values_to = "answer")
sanitation_information|> 
  filter(answer == 1) |> 
  group_by(information) |> 
  count() |>
  mutate(percent = n / nrow(sanitation) * 100)

# Create a bar plot for the summarized categorical data
sanitation_information |>
  filter(answer == 1) |>
  group_by(information) |>
  count() |>
  mutate(percent = n / nrow(sanitation) * 100) |>
  ggplot(aes(x = information, y = percent, fill = information)) +
  geom_bar(stat = "identity", position = position_dodge()) +
   geom_errorbar(aes(ymin = percent - 1, ymax = percent + 1), width = 0.5, color = "black") + 
  labs(title = "Source of Sanitation Information", x = "Information", y = "Percentage") +
  theme_classic()


#2 What are the consequences of not using latrines?(mark all that apply)

motivation <- sanitation_clean |> 
  select( disease_prevention:prestige) |> 
  pivot_longer(cols = disease_prevention:prestige,
               names_to = "consequences",
               values_to = "answer")
motivation|> 
  filter(answer == 1) |> 
  group_by(consequences) |> 
  count() |>
  mutate(percent = n / nrow(sanitation) * 100)


#3 What characteristics would you like to see in your latrine of choice? (mark all that apply)

latrine_charcteristics <- sanitation_clean |> 
  select( clean_floor_and_slab:lockable_door) |> 
  pivot_longer(cols = clean_floor_and_slab:lockable_door,
               names_to = "quality_of_toilet",
               values_to = "answer")
latrine_charcteristics |> 
  filter(answer == 1) |> 
  group_by(quality_of_toilet) |> 
  count() |> 
  mutate(percent = n / nrow(sanitation) * 100)

#4 What cultures do exist in your community that affect owning and use of latrines? (mark all that apply)

culture <- sanitation_clean |>
  select( in_laws_do_not_share :people_living_with_chronic_illnesses_do_not_share) |> 
  pivot_longer(cols = in_laws_do_not_share :people_living_with_chronic_illnesses_do_not_share,
               names_to = "existing_cultures",
               values_to = "answer")
culture |> 
  filter(answer == 1) |> 
  group_by(existing_cultures) |> 
  count() |> 
  mutate(percent = n / nrow(sanitation) * 100)

#5 What hinders you/people from your community from accessing financial services?(mark all that apply)

loan_factors <- sanitation_clean |>
  select(financial_knowledge:employment_status) |> 
  pivot_longer(cols = financial_knowledge:employment_status,
               names_to = "barrier_to _loan_services",
               values_to = "answer")
loan_factors |> 
  filter(answer == 1) |> 
  group_by(`barrier_to _loan_services`) |> 
  count() |> 
  mutate(percent = n / nrow(sanitation) * 100)
```

```{r}
#filter function
type_of_latrine <- sanitation_clean |>
  filter(!is.na(type_latrine_own)) |>
  group_by(type_latrine_own) |>
  count()
```

### Data visualization

```{r}
library(ggplot2)
# plot1- bar graph
ggplot(data = sanitation_clean, aes(x = age_bracket, fill = age_bracket)) +
  geom_bar(stat = "count", position = position_dodge()) +
  facet_grid(~willingness_to_invest) +
  ggtitle("Willingeness to invest in sanitation facilities by Age Bracket") +
  labs(x = "Age Bracket", y = "Count")

#plot2- scatter plot
sanitation_clean |>
filter(!is.na(income)) |>
ggplot(aes(household_size))+
  geom_point( stat = "count",aes(color = presence_of_latrine), alpha = 0.5)+
  facet_grid(willingness_to_invest ~ know_sanitation)

#plot- box plot
# Create a box plot
ggplot(sanitation_clean, aes(x = education, y = household_size)) +
  geom_boxplot(fill = "skyblue") +
  labs(title = "Household Size Distribution by eduction level", x = "education level", y = "household size") +
  theme_classic()
```

#saving data file

```{r}
write_csv(x = sanitation_clean, "/cloud/project/data/processed/sanitation_clean.csv" )
```

## Data analysis

```{r}
library(gtsummary)
library(ggplot2)
library(gt)
library(tidyverse)
```

Data import

```{r}
#importing proccesed data

sanitation_clean <- read_csv(here::here("/cloud/project/data/processed/sanitation_clean.csv"))
```

### demographic information of the respondents

```{r}
table1 <- sanitation_clean |>
  select(gender, age_bracket, religion, education, household_size) %>%
  tbl_summary(
    statistic = list(all_continuous() ~ "{mean} Â± {sd}")
  )
# Create a gt table
table1 |>
  as_gt() |>
  tab_header(
    title = "Demographic information of the respondents"
  ) |>
  tab_style(
    style = list(
      cell_text(size = "12px"),
      cell_fill(color = "#f7f7f7"),
      cell_borders(sides = "all", color = "white", weight = "1px")
    ),
    locations = cells_body()
  )
```

#data visualization of demographic characteristics of respondents

```{r}
#pie chart for gender distributions 
#Create a data frame with the gender distribution
gender_data <- data.frame(
  gender = c("Male", "Female", "Prefer not to say"),
  count = c(49, 48,2))

ggplot(gender_data, aes(x = "", y = count, fill = gender)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y") +
  labs(title = "Figure 1. Distribution of respondents by gender", fill = "gender") +
  theme_minimal()

#bar graph for education with error bar.
ggplot(sanitation_clean, aes(education, fill = education)) +
  geom_bar(stat = "count", fill = "skyblue") +
  labs(title = "Education Level Counts", x = "Education Level", y = "count") +
  theme_minimal()

#bar graph showing age_bracket of respondents against frequency "count"
ggplot(sanitation_clean, aes(x = age_bracket, fill = age_bracket)) +
  geom_bar(stat = "count") +
  labs(title = " Table 1 : Frequency of Respondents by Age Bracket", x = "Age Bracket", y = "Count")
#bar graph showing relogion of respondents against frequency "count"
ggplot(sanitation_clean,
       aes(x = religion, fill = religion))+
  geom_bar(stat = "count")+
  labs(title = " Table 2: Frequency of Respondents by religion", x = "religion", y = "Count")

# Create a histogram for the household_size variable
# Calculate the mean, standard deviation, and size of data
mean_hs <- mean(sanitation_clean$household_size)
sd_hs <- sd(sanitation_clean$household_size)
size_hs <- nrow(sanitation_clean)

# Create a histogram for the household_size variable
ggplot(sanitation_clean, aes(x = household_size)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "orange", alpha = 0.7) +
  stat_function(fun = dnorm, args = list(mean = mean_hs, sd = sd_hs), color = "red", size = 1)+
  annotate("text", x = 1, y = 20, label = paste("Mean:", round(mean_hs, 2), "\nSD:", round(sd_hs, 2), "\nSize:", size_hs), color = "black", size = 4) +
  labs(title = "Household Size Distribution", x = "Household Size", y = "Count") +
  theme_minimal()

```

#willingness to invest in sanitation

```{r}

sanitation_clean |> 
  tbl_summary(include = c(willingness_to_invest)) |>
  as_gt() |>
 gtsave(file = "table.html")
sanitation_clean |>
  tbl_cross(row = level_of_willingness,
            col = willingness_to_invest,
            percent = "cell") |> 
  add_p() 
  

```

#social factors and willingness to invest in sanitation

```{r}
library(epitools)

c1 <- table(willingness_to_invest, know_sanitation)
chisq_result <- chisq.test(c1)
odds_ratio <- oddsratio(c1)

# Create a table for the chi-squared test results
chisq_table <- data.frame(
  Test = c("X-squared", "df", "p-value"),
  Value = c(chisq_result$statistic, chisq_result$parameter, chisq_result$p.value)
)

# Create a table for the odds ratio results
odds_ratio_table <- data.frame(
  willingness_to_invest = c("no", "yes"),
  estimate = c(odds_ratio$measure[1, "estimate"], odds_ratio$measure[2, "estimate"]),
  lower = c(odds_ratio$measure[1, "lower"], odds_ratio$measure[2, "lower"]),
  upper = c(odds_ratio$measure[1, "upper"], odds_ratio$measure[2, "upper"]),
  p_value = c(odds_ratio$p.value[2, "midp.exact"], odds_ratio$p.value[2, "midp.exact"])
)

# Create the gt tables
chisq_gt <- gt(chisq_table) |> 
  tab_header(title = "Chi-squared Test Results")

odds_ratio_gt <- gt(odds_ratio_table) |> 
  tab_header(title = "Odds Ratio Results")

# Print the tables
print(chisq_gt)
print(odds_ratio_gt)
```

#economic factors and willingness to invest in sanita
